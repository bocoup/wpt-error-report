<!doctype html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="styles.css">
  <link rel="import" href="results.html">
</head>
<body>
<header>
  <h1>
    wpt-error-report
  </h1>
  <p>
    The following results consolidate broken test files in <a href="http://github.com/w3c/web-platform-tests">web platform tests</a> test suite that cause <a href="http://wpt.fyi">test results</a> to be inconsistent. Running at <code>e511e5e8af</code>.
  </p>
  <p>
    See <a href="https://github.com/GoogleChrome/wptdashboard/issues/98">GoogleChrome/wptdashboard/issues/98</a> for more discussion.
  </p>
</header>

<nav>
  <button class="toggle">Toggle All Results</button>
  <button class="sort" data-mode="by-failure">Sort Results by Failure</button>
</nav>

<script>
document.addEventListener("DOMContentLoaded", () => {

  // Add results to DOM
  let results = document.querySelector('link[rel="import"]');
  let main = results.import.querySelector('main');
  document.querySelector('body').appendChild(main);

  //Bind toggle and sorts
  let isOpen = false;
  document.querySelector('body').addEventListener("click", (event) => {
    if (event.target.tagName !== "BUTTON") {
      return
    }

    if (event.target.className === "toggle") {
      isOpen = !isOpen;
      [...document.querySelectorAll("details")].forEach(detail => {
        detail.open = isOpen;
      });
      return;
    }

    if (event.target.dataset.mode === "by-failure") {
      event.target.innerText="Sort Alphabetically"
      event.target.dataset.mode="by-alpha"
      resultsToDOM(resultsArr.sort(sortByFailures));
      return;
    }

    if (event.target.dataset.mode === "by-alpha") {
      event.target.innerText="Sort Results by Failure"
      event.target.dataset.mode="by-failure";
      resultsToDOM(resultsArr.sort(sortByAlpha));
      return;
    }

  });

  // Setup results for sorting
  let resultsArr = [];
  main.childNodes.forEach(function(elem){
    if (elem.nodeType == 1) { // get rid of the whitespace text nodes
      resultsArr.push(elem);
    }
  });

  function sortByFailures (a, b) {
    return parseInt(a.dataset.percent) === parseInt(b.dataset.percent) ? 0 : (parseInt(a.dataset.percent) > parseInt(b.dataset.percent) ? -1 : 1);
  };

  function sortByAlpha (a, b) {
    return a.innerText.substr(0,10) === b.innerText.substr(0,10) ? 0 : (a.innerText.substr(0,10) > b.innerText.substr(0,10)) ? 1 : -1;
  };

  function resultsToDOM (resultsArr) {
    main.innerHTML = '';
    resultsArr.forEach(function(elem){
      main.appendChild(elem);
    });
  }


}, false);
</script>
</body>
</html>
